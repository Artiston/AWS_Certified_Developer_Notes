Virtual Private Cloud Overview (Really important)

-Virtual data center but in the cloud
-Every region has their own VPC
-Complete control over your network: IP address range, subnets, routing tables and network gateways
-Security: security groups or network access control lists
-Can connect with your existing data center through the use of a VPN
-1 subnet = 1 AZ
-Private Ips:	
	- 10.0.0.0/8
	- 172.16.0.0/12
	- 192.168.0.0/16
-Can have multiple vpcs inside a region, max 5
-Smallest have a subnet mask of /28 = 16 IP addresses

What can you do:
- Launch instances into different subnets
- Assign custom IP adress ranges in each subnet
- configure route tables between subnets
	- Which subnets can speak to other subnets
- Create Internet gateway and attach it to vpc
	- IG are highly available, spread over AZ
- Much better security controls
- Instance security groups
- Subnet network access control lists (ACLs)

Default vs Custom
- user friendly
- all subnets have access to internet
- Each EC2 has both private and public IP addresses

VPC peering
- Connect two VPCs via a direct network route using private IP addresses
	- Instances will behave as if they were in the same private network
- Can peer vpcs with other AWS accounts
- Not transitive, explicitly declared


LAB
- Tenancy
	-Default shared hardware
	-Dedicated non shared hardware - more expensive
- On new VPC
	- Default Security groups
	- Default ACL
	- Default Route table
- AZ name doesnt mean they are in the same AZ 
- You'll lose 5 Ips when creating a subnet
	- network IP address
	- VPC router
	- DNS
	- Reserved for future use
	- Broadcast
- Security groups only exist within the VPC you create

NAT Instances and NAT Gateways

NAT instances:
- EC2 instance that works as a gateway for internet traffic.
	- Route table uses NAT instance
	- Has src/dest checks disabled
	- Prone to bottlenecks
	- Behind a security group
NAT Gateways:
- Preferred by enterprise
- Scale up automatically to 10 Gbps
- automatically assigned Ip public address
- Update route tables
- More secure (no ssh or patching)
- NAT gateways only ipv4
- Comparison https://docs.aws.amazon.com/AmazonVPC/latest/UserGuide/vpc-nat-comparison.html


NACL
- Only associated with one subnet
- No outbound or inbound traffic allowed by default on NEW ACL. Default ACL allows traffic 
- Stateless
- Ephemeral ports 
	- Port randomly assigned when a client connects to a server
	- Varies for OS
	- Amazon makes client choose the port that will be used
- Rules are evaluated in numerical order
- Rules are recommended to go in 100 increments so if you make a mistake you can correct it enough number of times
- Applied instantly
- Used for blocking ips
- Evaluated before security groups
- 1 subnet to 1 ACL
- 1 ACL to n subnet


Load Balancers and Custom VPCs
- You need 2 subnets within 2 AZ for it to work, both need IGW (be public)

VPC flow logs
- Feature that enables to capture information on IP traffic
- Store in cloudwatch logs
- Can be created at 3 levels
	- VPC
		- All traffic in the VPC
	- Subnet
		- Single subnet traffic
	- Network interface
- Need IAM role to be able to log to cloudwatch
- Needs log group on cloud watch
- Can be used with lambdas
- Peered VPC need to be under same account otherwise can't enable flowlogs
- Cannot tag
- Can't change config after creation
- Not all IP traffic is monitored
	- Using amazon DNS
	- Traffic generated by window instances for licenses
	- Traffic for instance metadata
	- DHCP
	- Traffic for IPs used by amazon

NAT vs Bastion
- NAT provide Internet access to EC2 in private subnets
- Bastion used to ssh and admnister services


VPC endpoint
- Secure connects a VPC to another service like S3
- They connect to services using the private IP addresses
